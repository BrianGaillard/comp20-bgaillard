<!DOCTYPE html>
<html>
  <head>
	<title>Lyft Knochoff</title>
	<meta name="viewport" content="initial-scale=1.0">
	<link rel="stylesheet" href="style.css"/>
	<meta charset="utf-8">
  </head>

  <body>
  	<div id="map"></div>
	<script>

	var myLat = 0.0;
	var myLng = 0.0;
	var me;
	var marker;
	var infoWindow;
	var map;
	
	var short_name;
	var image = 'thinking_emoji.png';

	function initMap() {
		map = new google.maps.Map(document.getElementById("map"), {
			center: {lat: myLat, lng: myLng},
			zoom: 13
		});
		getMyLocation();
	}

	function getMyLocation() {
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position){
			myLat = position.coords.latitude;
			myLng = position.coords.longitude;
			renderMap();
		});
	}
}

	function renderMap() {
		var shortest;
		me = new google.maps.LatLng(myLat,myLng);
		map.panTo(me);
		mymarker = new google.maps.Marker({
			position: me,
			title: "The closest person is "+shortest+" miles away!",
			icon: image
		});
		mymarker.setMap(map);

		infoWindow = new google.maps.InfoWindow();
		google.maps.event.addListener(mymarker,'click',function() {
			infoWindow.setContent(this.title);
			infoWindow.open(map, this);
		});
		getData();
	}

	function getData(){
		request = new XMLHttpRequest();

		request.open("POST", "https://hans-moleman.herokuapp.com/rides", true);

		request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

		request.onreadystatechange = function(){
			if (request.readyState == 4 && request.status == 200) {
				data = JSON.parse(request.responseText);
				console.log(data);
				parsing(data);
			}
		}

		request.send("username=m4Phs9fb&lat="+myLat+"&lng="+myLng);
	}

	function parsing(data) {
		var lat;
		var lng;
		
		if(data.passengers){
			console.log(data.passengers.length);
			for (count = 0; count < data.passengers.length; count++) {
				if (data.passengers[count].username == "WEINERMOBILE"){
					lat = data.passengers[count].lat;
					lng = data.passengers[count].lng;
					person = new google.maps.LatLng(lat,lng);
					marker = new google.maps.Marker({
					position: person,
					title: "It's the "+data.passengers[count].username+"!! It is at latitude "+lat+" and longitude "+lng+"!",
					icon: image = 'https://tuftsdev.github.io/WebProgramming/assignments/weinermobile.png'
				});
				marker.setMap(map);

				infoWindow = new google.maps.InfoWindow();
				google.maps.event.addListener(marker,'click',function() {
				infoWindow.setContent(this.title);
				infoWindow.open(map, this);
				});

				} else {
				lat = data.passengers[count].lat;
				lng = data.passengers[count].lng;
				person = new google.maps.LatLng(lat,lng);
				marker = new google.maps.Marker({
				position: person,
				title: "Passenger "+data.passengers[count].username+" is at latitude "+lat+" and longitude "+lng+"!",
				icon: image = 'thinking_emoji.png'
				});
				marker.setMap(map);

				infoWindow = new google.maps.InfoWindow();
				google.maps.event.addListener(marker,'click',function() {
				infoWindow.setContent(this.title);
				infoWindow.open(map, this);
				});
				}	
			}
			shortestDistance(data);
		}
		if(data.drivers){
			console.log(data.drivers.length);
			for (count = 0; count < data.drivers.length; count++) {
				if (data.drivers[count].username == "WEINERMOBILE"){
					lat = data.drivers[count].lat;
					lng = data.drivers[count].lng;
					person = new google.maps.LatLng(lat,lng);
					marker = new google.maps.Marker({
					position: person,
					title: "It's the "+data.passengers[count].username+"!! It is at latitude "+lat+" and longitude "+lng+"!",
					icon: image = 'https://tuftsdev.github.io/WebProgramming/assignments/weinermobile.png'
				});
				marker.setMap(map);

				infoWindow = new google.maps.InfoWindow();
				google.maps.event.addListener(marker,'click',function() {
				infoWindow.setContent(this.title);
				infoWindow.open(map, this);
				});

				} else {
				lat = data.drivers[count].lat;
				lng = data.drivers[count].lng;
				person = new google.maps.LatLng(lat,lng);
				marker = new google.maps.Marker({
				position: person,
				title: "Driver "+data.passengers[count].username+" is at latitude "+lat+" and longitude "+lng+"!",
				icon: image = 'https://tuftsdev.github.io/WebProgramming/assignments/car.png'
				});
				marker.setMap(map);

				infoWindow = new google.maps.InfoWindow();
				google.maps.event.addListener(marker,'click',function() {
				infoWindow.setContent(this.title);
				infoWindow.open(map, this);
				});
				}	
			}
		}

	function shortestDistance(data) {
		var lati;
		var long;
		var locations;
		shortest = 19996000;
		if (data.passengers){
			locations = Array(data.passengers.length);
			for (count = 0; count < data.passengers.length; count++) {
						lati = data.passengers[count].lat;
						long = data.passengers[count].lng;
						me = new google.maps.LatLng(myLat,myLng);
						console.log("me"+me);
						other = new google.maps.LatLng(lati,long);
						console.log("other"+other);

						value = google.maps.geometry.spherical.computeDistanceBetween(me, other);
						locations[count] = value;
						console.log("value"+value);
			}

			for (i = 1; i < data.passengers.length; i++) {
				if (locations[i] < shortest) {
					shortest = locations[i];
				}
			}
			shortest = shortest * 0.000621371;

		
			marker = new google.maps.Marker({
			position: me,
			title: "The closest person is "+shortest+" miles away!",
			icon: image
			});

			marker.setMap(map);

			infoWindow = new google.maps.InfoWindow();
			google.maps.event.addListener(marker,'click',function() {
			infoWindow.setContent(this.title);
			infoWindow.open(map, this);
			});

		}
		else if (data.drivers){
			locations = Array(data.drivers.length);
			for (count = 0; count < data.drivers.length; count++) {
						lat = data.drivers[count].lat;
						lng = data.drivers[count].lng;

			}
		}
	}
}


	</script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDHoxaiygdYABk5OHIZMOt-iizqXgrsdB8&callback=initMap&libraries=geometry"
	async defer> </script>
	
	<div id="infoWindow"></div>
   
  </body>
</html>