<!DOCTYPE html>
<html>
  <head>
	<title>Lyft Knochoff</title>
	<meta name="viewport" content="initial-scale=1.0">
	<link rel="stylesheet" href="style.css"/>
	<meta charset="utf-8">
  </head>

  <body>
  	<div id="map"></div>
	<script>

	var myLat = 0.0;
	var myLng = 0.0;
	var me;
	var marker;
	var infoWindow;
	var map;
	var image = 'thinking_emoji.png';

	function initMap() {
		map = new google.maps.Map(document.getElementById("map"), {
			center: {lat: myLat, lng: myLng},
			zoom: 13
		});
		getMyLocation();
	}

	function getMyLocation() {
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position){
			myLat = position.coords.latitude;
			myLng = position.coords.longitude;
			renderMap();
		});
	}
}

	function renderMap() {
		me = new google.maps.LatLng(myLat,myLng);
		map.panTo(me);
		marker = new google.maps.Marker({
			position: me,
			title: "You are here",
			icon: image
		});
		marker.setMap(map);

		infoWindow = new google.maps.InfoWindow();
		google.maps.event.addListener(marker,'click',function() {
			infoWindow.setContent(marker.title);
			infoWindow.open(map, marker);
		});
		getData();
	}

	function getData(){
		request = new XMLHttpRequest();

		request.open("POST", "https://hans-moleman.herokuapp.com/rides", true);

		request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

		request.onreadystatechange = function(){
			if (request.readyState == 4 && request.status == 200) {
				data = JSON.parse(request.responseText);
				console.log(data);
				parsing(data);
			}
		}

		request.send("username=m4Phs9fb&lat="+myLat+"&lng="+myLng);
	}

	function parsing(data){
		var lat;
		var lng;
		console.log(data.passengers[0].username)
		if(data.passengers){
			console.log(data.passengers[1].username)
			console.log(data.passengers.length);
			for (count = 0; count < data.passengers.length; count++) {
				if (data.passengers[count].username == "WEINERMOBILE"){
					lat = data.passengers[count].lat;
					lng = data.passengers[count].lng;
					person = new google.maps.LatLng(lat,lng);
					marker = new google.maps.Marker({
					position: person,
					title: data.passengers[count].username,
					icon: image = 'https://tuftsdev.github.io/WebProgramming/assignments/weinermobile.png'
				});
				marker.setMap(map);
				}
				lat = data.passengers[count].lat;
				lng = data.passengers[count].lng;
				person = new google.maps.LatLng(lat,lng);
				marker = new google.maps.Marker({
				position: person,
				title: data.passengers[count].username,
				icon: image = 'thinking_emoji.png'
				});
				marker.setMap(map);
			}
		}
		if(data.drivers){
			for (count = 0; count < data.length; count++) {
				//person = new google.maps.LatLng(lat,lng);
				marker = new google.maps.Marker({
				position: data[count].lat + data[count].lng,
				title: data[count].username,
				icon: image
				});
				marker.setMap(map);
			}
	}
}


	</script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDHoxaiygdYABk5OHIZMOt-iizqXgrsdB8&callback=initMap"
	async defer> </script>
	
	<div id="infoWindow"></div>
   
  </body>
</html>