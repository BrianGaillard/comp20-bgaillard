<!DOCTYPE html>
<html>
  <head>
	<title>Lyft Knochoff</title>
	<meta name="viewport" content="initial-scale=1.0">
	<link rel="stylesheet" href="style.css"/>
	<meta charset="utf-8">
  </head>

  <body>
  	<div id="map"></div>
	<script>

	var myLat = 0.0;
	var myLng = 0.0;
	var me;
	var marker;
	var infoWindow;
	var map;
	
	var short_name;
	var image = 'thinking_emoji.png';

	function initMap() {
		map = new google.maps.Map(document.getElementById("map"), {
			center: {lat: myLat, lng: myLng},
			zoom: 13
		});
		getMyLocation();
	}

	function getMyLocation() {
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position){
			myLat = position.coords.latitude;
			myLng = position.coords.longitude;
			renderMap();
		});
	}
}

	function renderMap() {
		var shortest;
		me = new google.maps.LatLng(myLat,myLng);
		map.panTo(me);
		// mymarker = new google.maps.Marker({
		// 	position: me,
		// 	title: "The closest person is "+shortest+" miles away!",
		// 	icon: "elephant.png"
		// });
		// mymarker.setMap(map);

		// infoWindow = new google.maps.InfoWindow();
		// google.maps.event.addListener(mymarker,'click',function() {
		// 	infoWindow.setContent(this.title);
		// 	infoWindow.open(map, this);
		// });
		getData();
	}

	function getData(){
		request = new XMLHttpRequest();

		request.open("POST", "https://hans-moleman.herokuapp.com/rides", true);

		request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

		request.onreadystatechange = function(){
			if (request.readyState == 4 && request.status == 200) {
				data = JSON.parse(request.responseText);
				console.log(data);
				parsing(data);
			}
		}

		request.send("username=m4Phs9fb&lat="+myLat+"&lng="+myLng);
	}

	function parsing(data) {
		var lat;
		var lng;
		
		if(data.passengers){
			console.log(data.passengers.length);
			for (count = 0; count < data.passengers.length; count++) {
				if (data.passengers[count].username == "WEINERMOBILE"){
					lat = data.passengers[count].lat;
					lng = data.passengers[count].lng;
					person = new google.maps.LatLng(lat,lng);
					marker = new google.maps.Marker({
					position: person,
					title: "It's the "+data.passengers[count].username+"!! It is at latitude "+lat+" and longitude "+lng+"!",
					icon: image = 'https://tuftsdev.github.io/WebProgramming/assignments/weinermobile.png'
				});
				marker.setMap(map);

				infoWindow = new google.maps.InfoWindow();
				google.maps.event.addListener(marker,'click',function() {
				infoWindow.setContent(this.title);
				infoWindow.open(map, this);
				});

				} else {
				lat = data.passengers[count].lat;
				lng = data.passengers[count].lng;
				person = new google.maps.LatLng(lat,lng);
				marker = new google.maps.Marker({
				position: person,
				title: "Passenger "+data.passengers[count].username+" is at latitude "+lat+" and longitude "+lng+"!",
				icon: image = 'thinking_emoji.png'
				});
				marker.setMap(map);

				infoWindow = new google.maps.InfoWindow();
				google.maps.event.addListener(marker,'click',function() {
				infoWindow.setContent(this.title);
				infoWindow.open(map, this);
				});
				}	
			}
			shortestDistance(data);
		}
		if(data.drivers){
			console.log(data.drivers.length);
			for (count = 0; count < data.drivers.length; count++) {
				if (data.drivers[count].username == "WEINERMOBILE"){
					lat = data.drivers[count].lat;
					lng = data.drivers[count].lng;
					person = new google.maps.LatLng(lat,lng);
					marker = new google.maps.Marker({
					position: person,
					title: "It's the "+data.passengers[count].username+"!! It is at latitude "+lat+" and longitude "+lng+"!",
					icon: image = 'https://tuftsdev.github.io/WebProgramming/assignments/weinermobile.png'
				});
				marker.setMap(map);

				infoWindow = new google.maps.InfoWindow();
				google.maps.event.addListener(marker,'click',function() {
				infoWindow.setContent(this.title);
				infoWindow.open(map, this);
				});

				} else {
				lat = data.drivers[count].lat;
				lng = data.drivers[count].lng;
				person = new google.maps.LatLng(lat,lng);
				marker = new google.maps.Marker({
				position: person,
				title: "Driver "+data.passengers[count].username+" is at latitude "+lat+" and longitude "+lng+"!",
				icon: image = 'https://tuftsdev.github.io/WebProgramming/assignments/car.png'
				});
				marker.setMap(map);

				infoWindow = new google.maps.InfoWindow();
				google.maps.event.addListener(marker,'click',function() {
				infoWindow.setContent(this.title);
				infoWindow.open(map, this);
				});
				}	
			}
		}

	function shortestDistance(data) {
		var lati;
		var long;
		var locations;
		var close_user = "Placeholder";
		//locations = Array(data.passengers.length);
		//locations = {}
		//locations = [];
		if (data.passengers){
			var locations = [];
			for (count = 0; count < data.passengers.length; count++) {
				locations.push({
					val: -99,
					user: data.passengers[count].username
				})
			}

			//locations = Array(data.passengers.length);
			for (count = 0; count < data.passengers.length; count++) {
						lati = data.passengers[count].lat;
						long = data.passengers[count].lng;
						me = new google.maps.LatLng(myLat,myLng);
						console.log("me "+me);
						other = new google.maps.LatLng(lati,long);
						console.log("other "+other);

						//var name = data.passengers[count].username;

						var value = google.maps.geometry.spherical.computeDistanceBetween(me, other);

						locations[count].val = value;
						console.log("value "+locations[count].val);
						console.log("username "+locations[count].user);
						{

						}

			}

			//keys = Object.keys(locations);

			//console.log("value? : "+ keys[0]);
			//console.log("name? : "+ locations[keys[0]]);
			var shortest = 19996000;
			//console.log("length "+ keys.length);

		// 	for (i = 0; i < locations.length; i++) {
		// 	console.log(keys[i] + " => " + locations[keys[i]]);
		// }
			var counting = 0;


			for (i = 0; i < locations.length; i++) {
				console.log("val : "+ locations[1].val);
				if (locations[i].val < shortest) {
					shortest = locations[i].val;
					close_user = locations[i].user;
					console.log("shortest - meters : "+ locations[i].val);
					console.log("thedude : "+ locations[i].user);
					console.log("new_shortest: "+ shortest);
				}
				counting++;
			}

			console.log("iterations "+counting);
			shortest = shortest / 1609.344;
			console.log("shortest distance: "+shortest);
			console.log("name of short: "+close_user);
			

		
			marker = new google.maps.Marker({
			position: me,
			title: "You are m4Phs9fb! The closest person is "+close_user+" and they are "+shortest+" miles away!",
			icon: "elephant.png"
			});

			marker.setMap(map);

			infoWindow = new google.maps.InfoWindow();
			google.maps.event.addListener(marker,'click',function() {
			infoWindow.setContent(this.title);
			infoWindow.open(map, this);
			});

		}
		else if (data.drivers){
			locations = Array(data.drivers.length);
			for (count = 0; count < data.drivers.length; count++) {
						lat = data.drivers[count].lat;
						lng = data.drivers[count].lng;

			}
		}
	}
}


	</script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDHoxaiygdYABk5OHIZMOt-iizqXgrsdB8&callback=initMap&libraries=geometry"
	async defer> </script>
	
	<div id="infoWindow"></div>
   
  </body>
</html>